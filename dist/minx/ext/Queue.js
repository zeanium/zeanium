!function(s){var t=Array.prototype.slice,r=Object.prototype.toString,e=0,n=1,o=3,i=s.Class({events:["init","stop","error","finished"],properties:{queue:null,status:null},methods:{init:function(s,t){if(this._queue=s,this._status=e,t&&"object"==typeof t)for(var i in t)this.on(i,t[i]);this.fire("init",s)},doTask:function(t,s){t||this.fire("error",err);var i=s||[];"[object Array]"!=r.call(i)&&(i=[i]),t.done=this.done.bind(this),t.processor=this,i.unshift(t);try{this._status=n,!1===t.handler.apply(t.context,i)&&this.fire("stop",i)}catch(s){!1===this.fireApply("error",s,t)?this.fire("stop",i):t.done(s)}},done:function(){this._status=o,this.fire("finished",t.call(arguments))}}}),h=s.Class({events:["clear","insert","pause","resume","stop","error","every","destroy","finally"],properties:{count:{get:function(){return this._tasks.length}}},methods:{init:function(s,t){if(this._tasks=[],this._taskProcessors=[],this._lastTask=null,this._data=[],this._max=(s||{}).max||1,t&&"object"==typeof t)for(var i in t)this.on(i,t[i])},destroy:function(){this._tasks=null,this._taskProcessors=null,this._lastTask=null,this._data=null,this._max=null,this.fire("destroy",this),this.super()},clear:function(){return this._tasks=[],this._lastTask=null,this.fire("clear"),this},pause:function(s){return this._paused=!0,0<s&&(this._pauseTimer=setTimeout(this.resume,s)),this.fire("pause",s),this},resume:function(){return this._pauseTimer&&clearTimeout(this._pauseTimer),this._paused=!1,this.doTask(),this.fire("resume",this),this},catch:function(s,t){return this.on("error",s,t||this),this},stop:function(s,t){return this.on("stop",s,t||this),this},finally:function(s,t){return this.on("finally",s,t||this),this},every:function(s,t){return this.on("every",s,t||this),this},unshift:function(s,t){return this.insert(s,t,0),this},push:function(s,t){return this.insert(s,t,-1),this},inserts:function(s,t,i){var r=s||[],e=i||0,n=this._tasks[0],o=null,h=null,r=r.map(function(s){return h={handler:s,context:t||this},o&&((h.previous=o).next=h),o=h}.bind(this));return n&&((o.next=n).previous=o),r.unshift(0),r.unshift(e),this._tasks.splice.apply(this._tasks,r),this},insert:function(s,t,i){var r={handler:s,context:t||this},e=i||-1;switch(e){case-1:this._lastTask&&(r.previous=r,this._lastTask.next=r),this._lastTask=r,this._tasks.push(r);break;case 0:var n=this._tasks[0];n&&((r.next=n).previous=r),this._tasks.unshift(r);break;default:this._tasks.splice(e,0,r)}return this.fire("insert",r),this},getTaskProcessor:function(){var s=null,t=this._taskProcessors.length;if(!t)return this.createTaskProcessor();for(var i=0;i<t;i++)if((s=this._taskProcessors[i]).status==o)return s;return this._max>t?this.createTaskProcessor():void 0},createTaskProcessor:function(){var s=new i(this,{finished:this.__onProcessorFinished.bind(this),stop:this.__onProcessorStop.bind(this),error:this.__onProcessorError.bind(this)});return this._taskProcessors.push(s),s},start:function(){return this._data=[],this.doTask()},doTask:function(s){if(!this._tasks)return this;var t=this._tasks.shift();if(!t)return this.fire("finally",Array.from(s||[]),{ownerFirst:!0,method:"apply"}),this.destroy(),null;var i=this.getTaskProcessor();return i&&(null!=s&&(t.previousResult=s),i.doTask(t,s)),this},__onProcessorFinished:function(s,t){this._data.push(t),!1!==this.fire("every",Array.from(t||[]),{ownerFirst:!0,method:"apply"})&&this.doTask(t)},__onProcessorStop:function(s,t){this.clear(),this.fire("stop",t,{ownerFirst:!0,method:"apply"}),this.fire("finally",Array.from(t||[]),{ownerFirst:!0,method:"apply"}),this.destroy()},__onProcessorError:function(s,t){var i=this.fire("error",s);if(!1===i)return!1;!0===i&&t.done.apply(t.processor,t.previousResult)}}});s.queue=function(s){return new h(s)}}(zn);