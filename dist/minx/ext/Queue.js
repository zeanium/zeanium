!function(s){var t=Array.prototype.slice,e=Object.prototype.toString,r=0,n=1,o=3,i=s.Class({events:["stop","error","finished"],properties:{status:null},methods:{init:function(s){if(this._status=r,s&&"object"==typeof s)for(var t in s)this.on(t,s[t])},doTask:function(t,s){var i=s||[];"[object Array]"!=e.call(i)&&(i=[i]),t.done=this.done.bind(this),t.processor=this,i.unshift(t);try{this._status=n;var r=t.handler.apply(t.context,i);!1===r&&(this._status=o,this.fire("stop",i)),null!=r&&t.done(r)}catch(s){this._status=o,this.fire("error",[s,t])}},done:function(){this._status=o,this.fire("finished",t.call(arguments))}}}),h=s.Class({events:["clear","insert","pause","resume","error","stop","every","destroy","finally"],methods:{init:function(s,t){if(this._tasks=[],this._taskProcessors=[],this._lastTask=null,this._data=[],this._max=(s||{}).max||1,t&&"object"==typeof t)for(var i in t)this.on(i,t[i],this)},destroy:function(){this._tasks=null,delete this._tasks,this._taskProcessors=null,delete this._taskProcessors,this._lastTask=null,delete this._lastTask,this._data=null,delete this._data,this._max=null,delete this._max,this.fire("destroy",this),this.dispose()},size:function(){return this._tasks.length},clear:function(){return this._tasks=[],this._data=[],this._lastTask=null,this.fire("clear"),this},pause:function(s){return this._paused=!0,0<s&&(this._pauseTimer=setTimeout(this.resume,s)),this.fire("pause",s),this},resume:function(){return this._pauseTimer&&clearTimeout(this._pauseTimer),this._paused=!1,this.doTask(),this.fire("resume",this),this},onError:function(s,t){return this.on("error",s,t||this),this},onStop:function(s,t){return this.on("stop",s,t||this),this},onEvery:function(s,t){return this.on("every",s,t||this),this},onFinally:function(s,t){return this.on("finally",s,t||this),this},unshift:function(s,t){return this.insert(s,t,0),this},push:function(s,t){return this.insert(s,t,-1),this},inserts:function(s,t,i){var r=s||[],e=i||0,n=this._tasks[0],o=null,h=null,r=r.map(function(s){return h={handler:s,context:t||this},o&&((h.previous=o).next=h),o=h}.bind(this));return n&&((o.next=n).previous=o),r.unshift(0),r.unshift(e),this._tasks.splice.apply(this._tasks,r),this},insert:function(s,t,i){var r={handler:s,context:t||this},e=i||-1;switch(e){case-1:this._lastTask&&(r.previous=r,this._lastTask.next=r),this._lastTask=r,this._tasks.push(r);break;case 0:var n=this._tasks[0];n&&((r.next=n).previous=r),this._tasks.unshift(r);break;default:this._tasks.splice(e,0,r)}return this.fire("insert",r),this},getTaskProcessor:function(){var s,t=this._taskProcessors.length;if(!t)return this.createTaskProcessor();for(var i=0;i<t;i++)if((s=this._taskProcessors[i]).status==o||s.status==r)return s;return this._max>t?this.createTaskProcessor():void 0},createTaskProcessor:function(){var s=new i({finished:this.__onProcessorFinished.bind(this),stop:this.__onProcessorStop.bind(this),error:this.__onProcessorError.bind(this)});return this._taskProcessors.push(s),s},start:function(){return this._data=[],this.doTask()},doTask:function(s){if(!this._tasks)return this;var i=this._tasks.shift();if(i){if(this._paused)return this;var t=this.getTaskProcessor();t&&(null!=s&&(i.previousResult=s),i.queue=this,i.error=function(s,t){this.error(s,t||i)}.bind(this),i.stop=this.stop.bind(this),t.doTask(i,s))}else this.finally.apply(this,s);return this},stop:function(){this.clear();var s=t.call(arguments);return!1!==this.fire("stop",s,{ownerFirst:!0,method:"apply"})&&this.finally.apply(this,s),this},error:function(s,t){var i=this.fire("error",[s,t],{ownerFirst:!0,method:"apply"});return!0===i&&t?t.done.apply(t.processor,t.previousResult):!1!==i&&this.finally(s,t),this},finally:function(){return this.fire("finally",t.call(arguments),{ownerFirst:!0,method:"apply"}),this.destroy(),this},__onProcessorFinished:function(s,t){this._data&&this._data.push(t),!1!==this.fire("every",t||[],{ownerFirst:!0,method:"apply"})&&this.doTask(t)},__onProcessorStop:function(s,t){this.stop.apply(this,t)},__onProcessorError:function(s,t){return this.error.apply(this,t)}}});s.queue=function(s,t){return new h(s,t)}}(zn);